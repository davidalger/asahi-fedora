#!/bin/sh

set -e

cd /opt/asahi-fedora

echo ""
echo "Downloading install script"
wget -q https://asahi-fedora-remix.org/install -O ./install

echo ""
echo "Configuring script"
echo ""
eval $(grep -E 'export\W+(VERSION_FLAG|INSTALLER_BASE|INSTALLER_DATA|REPO_BASE)=' ./install | tee /dev/stderr)

echo ""
echo "Fetching packages"

PACKAGES=$(curl -sL ${INSTALLER_DATA} | jq -r ' .os_list[]
    | select((.package | split("-")[3] // split("-")[2] | split(".")[0]) >= "20230328")
    | .package | split(".")[0]
')

mkdir -p ./os && cd ./os
for PACKAGE in ${PACKAGES}; do
    if [ ! -f ./${PACKAGE}.zip ]; then
        echo "--> ${PACKAGE} downloading"
        wget -nc ${REPO_BASE}/os/${PACKAGE}.zip
    else
        echo "--> ${PACKAGE} already present"
    fi
done
cd ../

echo ""
echo "Fetching firmware for stubOS"

# See the installer source for a list of URLs to firmware images
# https://github.com/AsahiLinux/asahi-installer/blob/main/src/main.py#L46-L89

mkdir -p ./ipsw && cd ./ipsw
IPSW_IMAGES=(
    https://updates.cdn-apple.com/2022SpringFCS/fullrestores/071-08757/74A4F2A1-C747-43F9-A22A-C0AD5FB4ECB6/UniversalMac_12.3_21E230_Restore.ipsw
    https://updates.cdn-apple.com/2022FallFCS/fullrestores/012-92188/2C38BCD1-2BFF-4A10-B358-94E8E28BE805/UniversalMac_13.0_22A380_Restore.ipsw
)
for IPSW_IMAGE in "${IPSW_IMAGES[@]}"; do
    wget -nc "${IPSW_IMAGE}"
done
cd ../

echo "Updating install script"
perl -pi -e 's#REPO_BASE=https.*#REPO_BASE=/opt/asahi-fedora\nexport IPSW_BASE="\$REPO_BASE/ipsw"#' ./install
chmod +x ./install
